name: ci

on:
  pull_request:
  push:
    branches: [master]
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  checks:
    name: checks (ruff+mypy+pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            project/pyproject.toml
            mypy.ini
            pytest.ini

      - name: Install project + dev tools
        run: |
          python -m pip install --upgrade pip
          # Pipeline package (src/)
          python -m pip install -e ./project

          # Dev tools
          python -m pip install ruff mypy pytest

          # Serving test deps (unit tests only; no docker/MLflow server)
          python -m pip install "mlflow>=2.13,<4.0" fastapi httpx requests pandas

      - name: Ruff (format + lint)
        run: |
          ruff format --check .
          ruff check .

      - name: Mypy
        run: |
          mypy --config-file mypy.ini project/src serving

      - name: Pytest
        run: |
          pytest -q

  smoke:
    name: smoke (docker compose e2e)
    runs-on: ubuntu-latest
    needs: checks
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images
        run: docker compose build

      - name: Start infra
        run: make up

      - name: Run pipeline
        run: make run-pipeline

      - name: Promote
        run: make promote

      - name: Serve
        run: make serve

      - name: Smoke test
        run: make smoke-test

      - name: Tear down
        if: always()
        run: make down
