name: ci

on:
  pull_request:
  push:
    branches: [master]
  schedule:
    - cron: "0 3 * * *" # nightly 03:00 UTC
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            project/pyproject.toml

      - name: Install project + dev tools
        run: |
          python -m pip install --upgrade pip
          pip install -e ./project
          pip install ruff mypy pytest

      - name: Ruff (format + lint)
        run: |
          ruff format --check .
          ruff check .

      - name: Mypy
        run: mypy project/src

      - name: Pytest
        run: pytest

  smoke:
    runs-on: ubuntu-latest
    needs: checks
    # Keep PRs fast: run e2e only on master pushes, nightly schedule, or manual trigger.
    if: github.event_name != 'pull_request'
    env:
      COMPOSE_DOCKER_CLI_BUILD: "1"
      DOCKER_BUILDKIT: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images
        run: docker compose build

      - name: Start infra
        run: make up

      - name: Run pipeline
        run: make run-pipeline

      - name: Promote
        run: make promote

      - name: Serve
        run: make serve

      - name: Smoke test
        run: make smoke-test

      - name: Debug logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --tail=200

      - name: Tear down
        if: always()
        run: make down
